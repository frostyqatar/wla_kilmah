<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ÙˆÙ„Ø§ ÙƒÙ„Ù…Ø© Ø¹Ø§Ù„Ø³Ø±ÙŠØ¹</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
*{box-sizing:border-box;font-family:'Cairo',sans-serif}
:root{
  /* New Color Palette */
  --primary: #607D7E;
  --primary-dark: #2B505C;
  --secondary: #1A303F;
  --background: #061826;
  --glass:rgba(96,125,126,.15);
  --success: #4ade80;
  --warning: #f59e0b;
  --error: #ef4444;
  --info: #3b82f6;
  --gold: #ffd700;
}
html,body{height:100%;overflow-x:hidden}
body{margin:0;color:#fff;min-height:100vh;transition:background-image .5s ease;background-color:var(--background);background-image:url("https://i.ibb.co/Y4LZLZBW/Chat-GPT-Image-Aug-2-2025-03-33-53-PM.png");background-size:500px;background-repeat:repeat;background-position:center;background-attachment:scroll}

/* Enhanced Button Styles */
button{padding:.9rem 1.2rem;font-size:1rem;border:none;border-radius:12px;cursor:pointer;background:var(--primary);color:#fff;transition:all .25s ease;font-weight:600;min-height:44px}
button:hover{background:var(--primary-dark);transform:translateY(-2px);box-shadow:0 8px 24px rgba(96,125,126,.25)}
button:active{transform:translateY(0) scale(.98)}
.btn-lg{font-size:1.1rem;padding:1rem 1.4rem;border-radius:14px;min-height:50px}
.btn-ghost{background:transparent;border:2px solid var(--primary);color:var(--primary)}
.btn-ghost:hover{background:var(--primary);color:#fff}
.btn-correct{background:var(--success)!important;color:#fff}
.btn-wrong{background:var(--error)!important}
.btn-skip{background:var(--info)!important}
.btn-end{background:var(--secondary)!important}
.btn-toggle{background:var(--warning)!important;color:#fff}
.btn-toggle:hover{background:#e49900!important}

.badge{display:inline-flex;align-items:center;gap:.35rem;padding:.4rem .8rem;background:var(--secondary);border-radius:999px;font-size:.85rem;border:1px solid var(--primary)}

.hero{position:relative;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:2rem}
.hero .card{position:relative;background:var(--glass);backdrop-filter:blur(12px);border:2px solid var(--primary);border-radius:20px;padding:2rem;width:min(92vw,720px);box-shadow:0 20px 40px rgba(6,24,38,.6);margin:0 auto}

/* Enhanced Title with Much Slower Pulse */
.title {
  font-size: clamp(2.2rem, 8vw, 3.8rem);
  margin: 0.4rem 0 1rem;
  text-align: center;
  color: black;
  text-shadow:
    -2px -2px 0 #ffffff,
     2px -2px 0 #ffffff,
    -2px  2px 0 #ffffff,
     2px  2px 0 #ffffff,
     0 0 30px var(--primary),
     0 0 50px var(--primary);
  animation: titlePulse 8s infinite ease-in-out;
  letter-spacing: 1px;
  font-weight: bold;
  text-transform: uppercase;
  line-height: 1.1;
  word-spacing: 0.05em;
}

@keyframes titlePulse {
  0% {
    text-shadow:
      -2px -2px 0 #ffffff,
       2px -2px 0 #ffffff,
      -2px  2px 0 #ffffff,
       2px  2px 0 #ffffff,
       0 0 18px var(--primary),
       0 0 32px var(--primary);
    transform: scale(1);
  }
  50% {
    text-shadow:
      -2px -2px 0 #ffffff,
       2px -2px 0 #ffffff,
      -2px  2px 0 #ffffff,
       2px  2px 0 #ffffff,
       0 0 50px var(--primary),
       0 0 90px var(--primary);
    transform: scale(1.03);
  }
  100% {
    text-shadow:
      -2px -2px 0 #ffffff,
       2px -2px 0 #ffffff,
      -2px  2px 0 #ffffff,
       2px  2px 0 #ffffff,
       0 0 18px var(--primary),
       0 0 32px var(--primary);
    transform: scale(1);
  }
}

.hero-grid{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem}
.hero .panel{background:var(--secondary);border:2px solid var(--primary);border-radius:16px;padding:1.5rem;width:100%}
.hero .actions{display:flex;gap:.8rem;flex-wrap:wrap;justify-content:center;margin-top:1rem}
.hero .stat{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin-top:.8rem}

/* Language Toggle */
.lang-toggle{position:fixed;top:20px;right:20px;z-index:1000;background:var(--warning);color:#fff;padding:.5rem 1rem;border-radius:8px;font-size:.9rem;border:none;font-weight:600}

.spark{position:fixed;inset:0;background:radial-gradient(600px 300px at 10% 10%,rgba(96,125,126,.12),transparent 60%),radial-gradient(500px 260px at 90% 20%,rgba(43,80,92,.12),transparent 60%),radial-gradient(500px 260px at 50% 100%,rgba(26,48,63,.12),transparent 60%);pointer-events:none}

#gameArea{display:none;flex-direction:column;align-items:center;gap:1rem;background:rgba(6,24,38,.8);padding:1.5rem;border-radius:16px;backdrop-filter:blur(8px);width:min(92vw,560px);margin:2rem auto;border:2px solid var(--primary)}
.row{display:flex;gap:.6rem;align-items:center;justify-content:center;flex-wrap:wrap}
#qr{position:relative;width:min(280px, 80vw);height:min(280px, 80vw);background:#fff;padding:.6rem;border-radius:16px;display:flex;align-items:center;justify-content:center;box-shadow:0 0 0 0 rgba(96,125,126,.6);transition:all .3s ease;border:3px solid var(--primary);overflow:hidden}
#qr.special{box-shadow:0 0 0 8px rgba(96,125,126,.4),0 0 30px 8px rgba(96,125,126,.4);animation:specialPulse 2s infinite}
@keyframes specialPulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}

/* Scan effect */
#qr.scan-phase::before{
  content:'';
  position:absolute;
  left:0; right:0;
  height:40%;
  top:-40%;
  background:linear-gradient(to bottom, rgba(59,130,246,0) 0%, rgba(59,130,246,.25) 50%, rgba(59,130,246,0) 100%);
  animation:scanSweep 2s linear infinite;
  pointer-events:none;
}
#qr.scan-phase::after{
  content:attr(data-scan-label);
  position:absolute;
  bottom:4px; left:50%;
  transform:translateX(-50%);
  background:rgba(26,48,63,.92);
  border:1px solid var(--primary);
  color:#fff;
  padding:.2rem .5rem;
  border-radius:999px;
  font-weight:700;
  font-size:clamp(10px, 2.8vw, 12px);
  text-shadow:0 0 8px var(--info);
  pointer-events:none;
}
@keyframes scanSweep{0%{top:-40%}100%{top:140%}}

#answer{font-size:1.8rem;font-weight:700;display:none;padding:1rem;background:var(--secondary);border-radius:12px;border:2px solid var(--primary);text-align:center}
#hint{font-size:2.0rem;color:#ffffff;min-height:1.2rem;text-align:center;font-weight:600}
#scoreboard{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center}

/* Enhanced Player with Golden Glow */
.player{background:var(--secondary);padding:.6rem 1rem;border-radius:12px;font-size:1rem;display:flex;align-items:center;gap:.4rem;transition:all .3s ease;border:2px solid transparent;position:relative}
.player.active{
  border-color:var(--gold);
  background:var(--primary);
  transform:scale(1.05);
  box-shadow:0 0 20px var(--gold), 0 0 40px rgba(255,215,0,.3);
  animation:goldenGlow 2s infinite ease-in-out;
}
.player span{font-weight:700;color:#fff}

@keyframes goldenGlow {
  0% {
    box-shadow: 0 0 20px var(--gold), 0 0 40px rgba(255,215,0,.3);
  }
  50% {
    box-shadow: 0 0 30px var(--gold), 0 0 60px rgba(255,215,0,.5);
  }
  100% {
    box-shadow: 0 0 20px var(--gold), 0 0 40px rgba(255,215,0,.3);
  }
}

#progress,#timer{font-size:1rem;background:var(--secondary);padding:.5rem .8rem;border-radius:10px;border:1px solid var(--primary);font-weight:600}
#timer.low{animation:blink 1s infinite;background:var(--error);border-color:var(--error)}
#timer.scan{background:var(--info);border-color:var(--info)}
#timer.paused{background:#6b7280;border-color:#6b7280}
@keyframes blink{50%{filter:brightness(1.4)}}
.controls-inline{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center}
.game-footer{display:flex;gap:.8rem;justify-content:center;margin-top:.6rem}

/* Hint menu */
.hint-menu{
  position:absolute;
  background:var(--secondary);
  border:2px solid var(--primary);
  border-radius:10px;
  padding:.4rem;
  display:none;
  z-index:150;
  min-width:200px;
  box-shadow:0 12px 24px rgba(0,0,0,.4);
}
.hint-menu.active{display:block}
.hint-menu .hint-title{
  font-weight:700;
  padding:.4rem .6rem .2rem;
  color:#e2e8f0;
  opacity:.9;
}
.hint-menu button{
  display:block;width:100%;
  text-align:start;
  background:transparent;
  border:none;color:#fff;
  padding:.5rem .6rem;border-radius:8px;
}
.hint-menu button:hover{background:var(--primary)}

/* Modals + Toasts (unchanged) */
.modal{position:fixed;inset:0;background:rgba(6,24,38,.85);display:none;align-items:center;justify-content:center;z-index:120;backdrop-filter:blur(4px);padding:1rem}
.modal.active{display:flex}
.modal .sheet{background:var(--secondary);border:2px solid var(--primary);border-radius:16px;width:min(96vw,760px);max-width:90vw;max-height:90vh;overflow-y:auto;padding:1.5rem;position:relative;box-shadow:0 20px 40px rgba(6,24,38,.8)}
.modal .close{position:absolute;top:12px;right:12px;width:40px;height:40px;border-radius:10px;background:transparent;border:2px solid var(--primary);color:var(--primary);font-size:20px;line-height:1;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
.modal .close:hover{background:var(--primary);color:#fff}
.stepbar{display:flex;gap:.5rem;margin:.5rem 0 1.5rem;justify-content:center;flex-wrap:wrap}
.step{padding:.5rem 1rem;border-radius:999px;background:var(--background);font-size:.9rem;opacity:.6;border:1px solid var(--primary);transition:all .3s}
.step.active{opacity:1;background:var(--primary);color:#fff}
.card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:.8rem}
.card{background:var(--background);border:2px solid var(--primary);border-radius:14px;padding:1rem}
.card h4{margin:.2rem 0 .5rem;font-size:1.1rem;color:var(--primary)}
.card p{margin:0 0 .6rem;color:#cbd5e1;font-size:.95rem}
.input{display:flex;flex-direction:column;gap:.3rem;margin:.5rem 0}
.input input,.input select,.input textarea{border-radius:12px;border:2px solid var(--primary);padding:.7rem;background:var(--background);color:#fff;transition:border-color .2s;min-height:44px}
.input input:focus,.input select:focus,.input textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(96,125,126,.2)}
.actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:1rem;flex-wrap:wrap}
.preview-box{background:var(--background);border:2px solid var(--primary);border-radius:12px;padding:.8rem;max-height:200px;overflow:auto}
.small{font-size:.9rem;color:#94a3b8}
#bgUpload{position:fixed;bottom:15px;right:15px;opacity:.2;cursor:pointer;z-index:50;transition:opacity .2s}
#bgUpload:hover{opacity:.7}
#toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:1rem 1.5rem;border-radius:12px;font-weight:600;display:none;z-index:200;box-shadow:0 10px 30px rgba(0,0,0,.5);letter-spacing:.3px;border:2px solid;animation:slideDown .3s ease}
@keyframes slideDown{from{transform:translateX(-50%) translateY(-100%);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
.toast-success{background:var(--success);color:#fff;border-color:var(--success)}
.toast-info{background:var(--info);color:#fff;border-color:var(--info)}
.toast-warn{background:var(--warning);color:#fff;border-color:var(--warning)}
.toast-error{background:var(--error);color:#fff;border-color:var(--error)}
.badges{display:flex;gap:.4rem;flex-wrap:wrap;justify-content:center}
.badge-pop{animation:pop .8s ease}
@keyframes pop{0%{transform:scale(.5);opacity:0}50%{transform:scale(1.1);opacity:1}100%{transform:scale(1);opacity:1}}

/* Game End Modal Styles */
.end-modal{background:linear-gradient(135deg, var(--secondary), var(--background));border:3px solid var(--primary);box-shadow:0 25px 50px rgba(6,24,38,.9)}
.winner-announcement{text-align:center;padding:2rem 1rem}
.winner-title{font-size:2.2rem;color:var(--primary);margin-bottom:1rem;text-shadow:0 0 20px var(--primary)}
.winner-name{font-size:1.8rem;font-weight:700;color:#fff;margin:1rem 0;padding:1rem;background:var(--primary);border-radius:12px;text-shadow:0 0 10px rgba(0,0,0,.5)}
.final-scores{margin:1.5rem 0;padding:1rem;background:var(--background);border-radius:12px;border:2px solid var(--primary)}
.score-item{display:flex;justify-content:space-between;align-items:center;padding:.5rem 0;border-bottom:1px solid var(--primary)}
.score-item:last-child{border-bottom:none}
.score-item.winner{background:rgba(96,125,126,.2);border-radius:8px;padding:.7rem;font-weight:700}
.celebration{font-size:3rem;margin:1rem 0;animation:celebrate 2s infinite}
@keyframes celebrate{0%{transform:scale(1) rotate(0deg)}25%{transform:scale(1.1) rotate(-5deg)}75%{transform:scale(1.1) rotate(5deg)}100%{transform:scale(1) rotate(0deg)}}

/* Enhanced Mobile Responsive Design */
@media (max-width: 768px) {
  .hero { min-height: 100vh; padding: 1rem; justify-content: flex-start; padding-top: 2rem; }
  .hero .card { padding: 1.5rem; width: 95vw; max-width: none; margin: 0; }
  .hero .panel { min-height: auto; padding: 1.2rem; }
  .title { font-size: clamp(1.8rem, 7vw, 2.5rem); margin: 0.2rem 0 0.8rem; line-height: 1.1; }
  .hero .actions { gap: 0.6rem; flex-direction: column; align-items: stretch; }
  .hero .actions button { width: 100%; padding: 1rem; font-size: 1rem; min-height: 50px; }
  button { padding: 0.8rem 1rem; font-size: 0.9rem; min-height: 44px; }
  .btn-lg { font-size: 1rem; padding: 1rem 1.2rem; min-height: 52px; }
  #gameArea { width: 95vw; padding: 1rem; margin: 1rem auto; }
  #qr { width: min(250px, 75vw); height: min(250px, 75vw); }
  #answer { font-size: 1.4rem; padding: 0.8rem; }
  .modal .sheet { width: 95vw; padding: 1rem; max-height: 85vh; }
  .card-grid { grid-template-columns: 1fr; }
  .stepbar { flex-direction: column; gap: 0.3rem; }
  .step { text-align: center; font-size: 0.8rem; }
  .actions { justify-content: center; }
  .controls-inline { gap: 0.4rem; flex-direction: column; align-items: stretch; }
  .controls-inline button { width: 100%; min-height: 48px; }
  .player { font-size: 0.9rem; padding: 0.5rem 0.8rem; }
  .winner-title { font-size: 1.8rem; }
  .winner-name { font-size: 1.4rem; }
  .lang-toggle { top: 10px; right: 10px; padding: 0.4rem 0.8rem; font-size: 0.8rem; }
}

@media (max-width: 480px) {
  .hero { padding: 0.5rem; padding-top: 1.5rem; }
  .hero .card { padding: 1rem; border-radius: 16px; }
  .hero .panel { padding: 1rem; }
  .title { font-size: clamp(1.5rem, 6vw, 2rem); margin: 0.1rem 0 0.6rem; }
  .hero .actions button { padding: 0.9rem; font-size: 0.95rem; }
  button { padding: 0.7rem 0.9rem; font-size: 0.85rem; }
  #qr { width: min(220px, 70vw); height: min(220px, 70vw); }
  #answer { font-size: 1.2rem; }
  .modal .sheet { padding: 0.8rem; }
  .card { padding: 0.8rem; }
  .input input, .input select, .input textarea { padding: 0.6rem; }
  .lang-toggle { top: 8px; right: 8px; padding: 0.3rem 0.6rem; font-size: 0.75rem; }
}

@media (max-width: 390px) {
  .hero { padding: 0.3rem; padding-top: 1rem; }
  .hero .card { padding: 0.8rem; width: 98vw; }
  .hero .panel { padding: 0.8rem; }
  .title { font-size: clamp(1.3rem, 5vw, 1.8rem); margin: 0 0 0.5rem; }
  .hero .actions { gap: 0.4rem; }
  .hero .actions button { padding: 0.8rem; font-size: 0.9rem; min-height: 46px; }
  .controls-inline button { min-height: 46px; font-size: 0.85rem; }
  .lang-toggle { top: 5px; right: 5px; padding: 0.25rem 0.5rem; font-size: 0.7rem; }
}

@media (orientation: portrait) and (max-height: 700px) {
  .hero { min-height: 100vh; justify-content: center; }
  .hero .card { max-height: 90vh; overflow-y: auto; }
}

/* Tablet Landscape */
@media (min-width: 769px) and (max-width: 1024px) {
  .hero .card { width: 85vw; }
  #gameArea { width: 85vw; }
  .modal .sheet { width: 85vw; }
}

/* Large screens */
@media (min-width: 1200px) {
  .title { font-size: 4.2rem; }
  .hero .card { max-width: 800px; }
}
</style>
</head>
<body>
<button class="lang-toggle" id="langToggle">English</button>

<section class="hero" id="home">
  <div class="spark"></div>
  <div class="card">
    <div class="title" data-ar="ÙˆÙ„Ø§ ÙƒÙ„Ù…Ø© Ø¹Ø§Ù„Ø³Ø±ÙŠØ¹" data-en="Quick Charades">ÙˆÙ„Ø§ ÙƒÙ„Ù…Ø© Ø¹Ø§Ù„Ø³Ø±ÙŠØ¹</div>
    <div class="hero-grid">
      <div class="panel">
        <div class="actions">
          <button id="setupBtn" class="btn-ghost" data-ar="Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø©" data-en="Game Setup">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
          <button id="startBtn" class="btn-lg" data-ar="Ø¨Ù„Ø´ Ø§Ù„Ù‚ÙŠÙ…" data-en="Start Game">Ø¨Ù„Ø´ Ø§Ù„Ù‚ÙŠÙ…</button>
          <button id="previewBtn" class="btn-ghost" data-ar="Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø§Øª" data-en="Preview Words">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
        </div>
        <div class="stat" id="homeStats"></div>
      </div>
    </div>
  </div>
</section>

<div id="gameArea">
  <div class="row">
    <div id="turn" class="badge" data-ar="Ø§Ù„Ø¯ÙˆØ±" data-en="Turn">Ø§Ù„Ø¯ÙˆØ±</div>
    <div id="modeBadge" class="badge"><span data-ar="ÙˆØ¶Ø¹: Ø£ÙØ±Ø§Ø¯" data-en="Mode: Individual">ÙˆØ¶Ø¹: Ø£ÙØ±Ø§Ø¯</span></div>
  </div>
  <div class="row">
    <div id="progress"></div>
    <div style="display:flex;gap:.5rem;align-items:center;">
      <div id="timer"></div>
      <button id="pauseBtn" class="btn-ghost" data-ar="Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª" data-en="Pause">Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
    </div>
  </div>
  <div id="qr"></div>
  <div id="hint"></div>
  <div id="answer"></div>
  <div id="scoreboard"></div>
  <div id="playRow" class="controls-inline">
    <button id="revealBtn" data-ar="ÙƒØ´Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©" data-en="Reveal Answer">ÙƒØ´Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
    <button id="hintBtn" data-ar="ØªÙ„Ù…ÙŠØ­" data-en="Hint">ØªÙ„Ù…ÙŠØ­</button>
  </div>
  <div id="actionRow" style="display:none" class="controls-inline">
    <button id="correctBtn" class="btn-correct" data-ar="ØµØ­ÙŠØ­ âœ“" data-en="Correct âœ“">ØµØ­ÙŠØ­ âœ“</button>
    <button id="wrongBtn" class="btn-wrong" data-ar="Ø®Ø·Ø£ âœ—" data-en="Wrong âœ—">Ø®Ø·Ø£ âœ—</button>
    <button id="skipBtn" class="btn-skip" data-ar="ØªØ®Ø·ÙÙ‘ Ø§Ù„ÙƒÙ„Ù…Ø©" data-en="Skip Word">ØªØ®Ø·ÙÙ‘ Ø§Ù„ÙƒÙ„Ù…Ø©</button>
  </div>
  <div class="game-footer">
    <button id="endGameInPlay" class="btn-end" data-ar="Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø©" data-en="End Game & Return">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø©</button>
  </div>
  <div class="badges" id="achievements"></div>
</div>

<!-- Game End Modal -->
<div class="modal" id="gameEndModal">
  <div class="sheet end-modal">
    <div class="winner-announcement">
      <div class="celebration">ğŸ‰</div>
      <div class="winner-title" data-ar="Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!" data-en="Game Over!">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</div>
      <div class="winner-name" id="winnerName">Ø§Ù„ÙØ§Ø¦Ø²</div>
      <div class="final-scores" id="finalScores"></div>
      <div class="actions" style="justify-content:center;margin-top:2rem">
        <button id="playAgainBtn" class="btn-lg" data-ar="Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰" data-en="Play Again">Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
        <button id="backToHomeBtn" class="btn-ghost" data-ar="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©" data-en="Back to Menu">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="setupModal">
  <div class="sheet">
    <button id="closeSetup" class="close" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
    <div class="stepbar">
      <div class="step" id="s1"><span data-ar="1) Ø§Ù„ÙˆØ¶Ø¹ ÙˆØ§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†" data-en="1) Mode & Players">1) Ø§Ù„ÙˆØ¶Ø¹ ÙˆØ§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†</span></div>
      <div class="step" id="s2"><span data-ar="2) Ù…ØµØ¯Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª" data-en="2) Word Source">2) Ù…ØµØ¯Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª</span></div>
      <div class="step" id="s3"><span data-ar="3) Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" data-en="3) Review">3) Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span></div>
    </div>
    <div id="step1">
      <div class="card-grid">
        <div class="card">
          <h4 data-ar="Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¶Ø¹" data-en="Choose Mode">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¶Ø¹</h4>
          <div class="input">
            <label><input type="radio" name="mode" value="individual" checked> <span data-ar="Ø£ÙØ±Ø§Ø¯" data-en="Individual">Ø£ÙØ±Ø§Ø¯</span></label>
            <label><input type="radio" name="mode" value="team"> <span data-ar="ÙØ±Ù‚" data-en="Teams">ÙØ±Ù‚</span></label>
          </div>
          <div class="input" id="individualInputs">
            <label data-ar="Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†" data-en="Number of Players">Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</label>
            <input type="number" id="playersCount" min="1" value="3">
          </div>
          <div class="input" id="teamInputs" style="display:none;">
            <label data-ar="Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Ù‚" data-en="Number of Teams">Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Ù‚</label>
            <input type="number" id="teamsCount" min="2" value="2">
          </div>
        </div>
        <div class="card">
          <h4 data-ar="Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙˆØª" data-en="Sound Options">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙˆØª</h4>
          <div class="input"><label><input type="checkbox" id="muteOnStart"> <span data-ar="ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡" data-en="Mute sound on start">ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡</span></label></div>
          <p class="small" data-ar="ÙŠÙ…ÙƒÙ†Ùƒ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ØªØºÙŠÙŠØ±Ù‡ Ù…Ù† Ø²Ø± Ø§Ù„ÙƒØªÙ…." data-en="You can always change it with the mute button.">ÙŠÙ…ÙƒÙ†Ùƒ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ØªØºÙŠÙŠØ±Ù‡ Ù…Ù† Ø²Ø± Ø§Ù„ÙƒØªÙ….</p>
        </div>
        <div class="card">
          <h4 data-ar="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Øª" data-en="Time Settings">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Øª</h4>
          <div class="input">
            <label for="scanSecsInput" data-ar="Ù…Ø¯Ø© Ø§Ù„Ù…Ø³Ø­ (Ø«ÙˆØ§Ù†Ù)" data-en="Scan duration (seconds)">Ù…Ø¯Ø© Ø§Ù„Ù…Ø³Ø­ (Ø«ÙˆØ§Ù†Ù)</label>
            <input type="number" id="scanSecsInput" min="5" max="60" value="20">
          </div>
          <p class="small" data-ar="Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø³Ù…ÙˆØ­: 5â€“60 Ø«Ø§Ù†ÙŠØ©" data-en="Allowed range: 5â€“60 seconds">Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø³Ù…ÙˆØ­: 5â€“60 Ø«Ø§Ù†ÙŠØ©</p>
        </div>
      </div>
      <div class="actions">
        <button id="toStep2" data-ar="Ø§Ù„ØªØ§Ù„ÙŠ" data-en="Next">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      </div>
    </div>
    <div id="step2" style="display:none;">
      <div class="card-grid">
        <div class="card">
          <h4 data-ar="Ù„ØµÙ‚/ØªØ­Ø±ÙŠØ± Ù‚Ø§Ø¦Ù…Ø©" data-en="Paste/Edit List">Ù„ØµÙ‚/ØªØ­Ø±ÙŠØ± Ù‚Ø§Ø¦Ù…Ø©</h4>
          <div class="input">
            <textarea id="pasteArea"
              placeholder="Ø§Ù„ØµÙ‚ Ù‡Ù†Ø§ (Ø³Ø·Ø± Ù„ÙƒÙ„ ÙƒÙ„Ù…Ø©)"
              data-ar="Ø§Ù„ØµÙ‚ Ù‡Ù†Ø§ (Ø³Ø·Ø± Ù„ÙƒÙ„ ÙƒÙ„Ù…Ø©)"
              data-en="Paste here (one word per line)"></textarea>
          </div>
          <div class="actions">
            <button id="saveDirect" data-ar="Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø±Ø©" data-en="Save Direct">Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø±Ø©</button>
            <button id="saveWithGemini" data-ar="ØªÙ†Ø¸ÙŠÙ Ø¨Ù€ Gemini Ø«Ù… Ø­ÙØ¸" data-en="Clean with Gemini then Save">ØªÙ†Ø¸ÙŠÙ Ø¨Ù€ Gemini Ø«Ù… Ø­ÙØ¸</button>
          </div>
        </div>
        <div class="card">
          <h4 data-ar="ØªÙˆÙ„ÙŠØ¯ Ø¨Ù‚Ø§Ø¦Ù…Ø© Gemini" data-en="Generate with Gemini">ØªÙˆÙ„ÙŠØ¯ Ø¨Ù‚Ø§Ø¦Ù…Ø© Gemini</h4>
          <div class="input"><label data-ar="Ù…ÙØªØ§Ø­ Gemini Flash API" data-en="Gemini Flash API Key">Ù…ÙØªØ§Ø­ Gemini Flash API</label><input type="password" id="geminiKeyInput" data-ar="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙØªØ§Ø­" data-en="Enter API Key"></div>
          <div class="input"><label data-ar="Ø¹Ù† Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø§Ù„ÙƒÙ„Ù…Ø§ØªØŸ" data-en="What topic for words?">Ø¹Ù† Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø§Ù„ÙƒÙ„Ù…Ø§ØªØŸ</label><input type="text" id="geminiTopic" data-ar="Ù…Ø«Ø§Ù„: Ø³ÙØ±ØŒ Ù…Ø³Ù„Ø³Ù„Ø§Øª ÙƒÙˆÙŠØªÙŠØ©ØŒ Ø·Ø¨ÙŠØ¹Ø©..." data-en="Example: travel, movies, nature..."></div>
          <div class="input"><label data-ar="Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª" data-en="Number of Words">Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</label><input type="number" id="geminiCount" min="5" max="50" value="20"></div>
          <div class="actions"><button id="generateGemini" data-ar="ØªÙˆÙ„ÙŠØ¯ ÙˆÙ…Ø¹Ø§ÙŠÙ†Ø©" data-en="Generate & Preview">ØªÙˆÙ„ÙŠØ¯ ÙˆÙ…Ø¹Ø§ÙŠÙ†Ø©</button></div>
          <div class="preview-box" id="geminiPreview" style="display:none"></div>
          <div class="actions" id="geminiAcceptRow" style="display:none"><button id="acceptGemini" data-ar="Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" data-en="Accept List">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button></div>
        </div>
      </div>
      <div class="actions">
        <button id="backTo1" data-ar="Ø§Ù„Ø³Ø§Ø¨Ù‚" data-en="Previous">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <button id="toStep3" data-ar="Ø§Ù„ØªØ§Ù„ÙŠ" data-en="Next">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      </div>
    </div>
    <div id="step3" style="display:none;">
      <div class="card-grid">
        <div class="card">
          <h4 data-ar="Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©" data-en="Final Review">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h4>
          <p id="summary"></p>
          <div class="preview-box" id="finalPreview"></div>
        </div>
      </div>
      <div class="actions">
        <button id="backTo2" data-ar="Ø§Ù„Ø³Ø§Ø¨Ù‚" data-en="Previous">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <button id="confirmSetup" data-ar="Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ§Ù„Ø¨Ø¯Ø¡" data-en="Confirm & Start">Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ§Ù„Ø¨Ø¯Ø¡</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="previewModal">
  <div class="sheet">
    <h3 data-ar="Ù…Ø¹Ø§ÙŠÙ†Ø© ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©" data-en="Preview Game Words">Ù…Ø¹Ø§ÙŠÙ†Ø© ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h3>
    <div class="preview-box" id="previewList"></div>
    <div class="actions"><button id="closePreview" data-ar="Ø¥ØºÙ„Ø§Ù‚" data-en="Close">Ø¥ØºÙ„Ø§Ù‚</button></div>
  </div>
</div>

<div class="modal" id="apiKeyModal">
  <div class="sheet">
    <h3 data-ar="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Gemini" data-en="Enter Gemini Key">Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Gemini</h3>
    <div class="input"><input type="password" id="apiKeyField" data-ar="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙØªØ§Ø­" data-en="Enter API Key"></div>
    <div class="actions"><button id="cancelApi" data-ar="Ø¥Ù„ØºØ§Ø¡" data-en="Cancel">Ø¥Ù„ØºØ§Ø¡</button><button id="confirmApi" data-ar="ØªØ£ÙƒÙŠØ¯" data-en="Confirm">ØªØ£ÙƒÙŠØ¯</button></div>
  </div>
</div>

<input type="file" accept="image/*" id="bgUpload" title="Ø±ÙØ¹ Ø®Ù„ÙÙŠØ©" />
<div id="toast"></div>
<audio id="bgm" src="https://archive.org/download/arabic-8-bit/arabic-8bit.mp3" loop></audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
<script>
// Language System
let currentLang = 'ar';
const translations = {
  ar: {
    'player': 'Ø§Ù„Ù„Ø§Ø¹Ø¨',
    'team': 'Ø§Ù„ÙØ±ÙŠÙ‚',
    'turn': 'Ø¯ÙˆØ±',
    'mode_individual': 'ÙˆØ¶Ø¹: Ø£ÙØ±Ø§Ø¯',
    'mode_team': 'ÙˆØ¶Ø¹: ÙØ±Ù‚',
    'word': 'ÙƒÙ„Ù…Ø©',
    'of': 'Ù…Ù†',
    'points': 'Ù†Ù‚Ø·Ø©',
    'hint': 'ØªÙ„Ù…ÙŠØ­: ',
    'no_words': 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ø¹Ø±Ø¶',
    'empty_list': 'Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ© Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­Ø©',
    'saved_direct': 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø±Ø©',
    'enter_key': 'Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Gemini',
    'no_preview': 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø©',
    'accepted_gemini': 'ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Gemini',
    'no_words_error': 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª',
    'connection_error': 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Gemini',
    'empty_paste': 'Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©',
    'no_valid_words': 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª ØµØ§Ù„Ø­Ø©',
    'cleaned_saved': 'ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ù„Ø­ÙØ¸',
    'setup_ready': 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬Ø§Ù‡Ø² â€” Ø§Ø¶ØºØ· Â«Ø¨Ù„Ø´ Ø§Ù„Ù‚ÙŠÙ…Â»',
    'current_list': 'Ù‚Ø§Ø¦Ù…Ø© Ø­Ø§Ù„ÙŠØ©: ',
    'words': 'ÙƒÙ„Ù…Ø©',
    'scored': 'Ø³Ø¬Ù‘Ù„',
    'wrong_answer': 'Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©',
    'speed_bonus': 'âš¡ Ù…ÙƒØ§ÙØ£Ø© Ø³Ø±Ø¹Ø©',
    'reached_10': 'ğŸ’¯ ÙˆØµÙ„Øª 10 Ù†Ù‚Ø§Ø·',
    'confirm_end': 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŸ',
    'hint_used': 'ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ„Ù…ÙŠØ­ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 0.5 Ù†Ù‚Ø·Ø©)',
    'sounds_muted': 'ØªÙ… ÙƒØªÙ… Ø§Ù„Ø£ØµÙˆØ§Øª',
    'sounds_on': 'ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª',
    'no_word_list': 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ„Ù…Ø§Øª. Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©. Ù…ÙˆØ§ÙÙ‚ØŸ',
    'setup_first': 'Ø£Ø¯Ø®Ù„/ÙˆÙ„Ù‘Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø©',
    'new_game_start': 'Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¯Ø£Øª!',
    'winner': 'Ø§Ù„ÙØ§Ø¦Ø²',
    'scan_qr': 'Ù‚Ù… Ø¨Ù…Ø³Ø­ Ø±Ù…Ø² QR',
    'scan_free': 'Ø§Ù…Ø³Ø­ Ø§Ù„Ø±Ù…Ø²',
    'pause': 'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª',
    'resume': 'Ø§Ø³ØªØ¦Ù†Ø§Ù',
    'paused': 'Ù…ØªÙˆÙ‚Ù Ù…Ø¤Ù‚ØªÙ‹Ø§',
    'scan': 'Ù…Ø³Ø­',
    'reveal_begin': 'ÙƒØ´Ù Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
    'reveal_middle': 'ÙƒØ´Ù Ø§Ù„ÙˆØ³Ø·',
    'reveal_end': 'ÙƒØ´Ù Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
    'choose_hint_part': 'Ø§Ø®ØªØ± Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ø±Ø§Ø¯ ÙƒØ´ÙÙ‡'
  },
  en: {
    'player': 'Player',
    'team': 'Team',
    'turn': 'Turn',
    'mode_individual': 'Mode: Individual',
    'mode_team': 'Mode: Teams',
    'word': 'Word',
    'of': 'of',
    'points': 'points',
    'hint': 'Hint: ',
    'no_words': 'No words to display',
    'empty_list': 'List is empty or invalid',
    'saved_direct': 'Saved directly',
    'enter_key': 'Enter Gemini key',
    'no_preview': 'No preview available',
    'accepted_gemini': 'Gemini list accepted',
    'no_words_error': 'Could not get words',
    'connection_error': 'Error connecting to Gemini',
    'empty_paste': 'List is empty',
    'no_valid_words': 'Could not get valid words',
    'cleaned_saved': 'Cleaned and saved',
    'setup_ready': 'Setup ready â€” press Â«Start GameÂ»',
    'current_list': 'Current list: ',
    'words': 'words',
    'scored': 'scored',
    'wrong_answer': 'Wrong answer',
    'speed_bonus': 'âš¡ Speed bonus',
    'reached_10': 'ğŸ’¯ Reached 10 points',
    'confirm_end': 'Do you want to end the round and return to the main page?',
    'hint_used': 'Hint used (max 0.5 points)',
    'sounds_muted': 'Sounds muted',
    'sounds_on': 'Sounds on',
    'no_word_list': 'No word list. We will use the default list. OK?',
    'setup_first': 'Enter/generate a list first from game setup',
    'new_game_start': 'New game started!',
    'winner': 'Winner',
    'scan_qr': 'Scan the QR code',
    'scan_free': 'First 20 seconds are free for scanning',
    'pause': 'Pause',
    'resume': 'Resume',
    'paused': 'Paused',
    'scan': 'Scan',
    'reveal_begin': 'Reveal beginning',
    'reveal_middle': 'Reveal middle',
    'reveal_end': 'Reveal end',
    'choose_hint_part': 'Choose which part to reveal'
  }
};

function translate(key) {
  return translations[currentLang][key] || key;
}

function updateLanguage() {
  const elements = document.querySelectorAll('[data-ar][data-en]');
  elements.forEach(el => {
    if (el.tagName === 'INPUT' && (el.type === 'text' || el.type === 'password')) {
      el.placeholder = el.getAttribute(`data-${currentLang}`);
    } else if (el.tagName === 'TEXTAREA') {
      if (currentLang === 'ar') {
        el.placeholder = el.getAttribute('data-ar');
      } else {
        el.placeholder = el.getAttribute('data-en');
      }
    } else {
      el.textContent = el.getAttribute(`data-${currentLang}`);
    }
  });

  // Update HTML attributes
  document.documentElement.lang = currentLang;
  document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';

  // Update language toggle button
  document.getElementById('langToggle').textContent = currentLang === 'ar' ? 'English' : 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';

  // Update pause button text to reflect state
  const pauseBtn = document.getElementById('pauseBtn');
  if (pauseBtn) pauseBtn.textContent = translate(paused ? 'resume' : 'pause');

  // Update dynamic content
  updateHomeStats();
  if (document.getElementById('gameArea').style.display === 'flex') {
    updateGameUI();
  }
}

document.getElementById('langToggle').onclick = () => {
  currentLang = currentLang === 'ar' ? 'en' : 'ar';
  updateLanguage();
  localStorage.setItem('gameLanguage', currentLang);
};

// Load saved language
const savedLang = localStorage.getItem('gameLanguage');
if (savedLang && savedLang !== currentLang) {
  currentLang = savedLang;
  updateLanguage();
}

const bgm=document.getElementById('bgm');bgm.volume=0.15;

// Default background rotation when no user-uploaded image exists
const DEFAULT_BACKGROUNDS=[
  'https://i.ibb.co/Y4LZLZBW/Chat-GPT-Image-Aug-2-2025-03-33-53-PM.png',
  'https://i.ibb.co/yn0HDC7t/Copilot-20250809-132708.png',
  
  'https://i.ibb.co/1ftmgp0x/Copilot-20250809-132614.png',
  'https://i.ibb.co/hxnvfQ02/Copilot-20250809-132532.png', 
  'https://i.ibb.co/9kYj1Q2p/BCO-3e5d8451-73d4-47e0-a130-ed9dddd14663.png',
  'https://i.ibb.co/yn0HDC7t/Copilot-20250809-132708.png',
  'https://i.ibb.co/RpVXfvNh/BCO-e88a3999-94b0-4d10-8580-40b4c8596d47.png',
  'https://i.ibb.co/hxnvfQ02/Copilot-20250809-132532.png',
  'https://i.ibb.co/zhzqwzPQ/BCO-3a07ada7-d526-41e8-96a7-58ae92e8c887.png',
  'https://i.ibb.co/yn0HDC7t/Copilot-20250809-132708.png',
  'https://i.ibb.co/rGSRpxCC/BCO-a60f9c50-e81c-4c79-a040-1bbd352fbd77.png'
];
let bgRotationTimer=null,bgRotationIndex=0;
const DEFAULT_BG_ROTATE_SECS=160; //This is where you modify the seconds to change it after testing
function setDefaultBackground(index){
  const url=DEFAULT_BACKGROUNDS[index % DEFAULT_BACKGROUNDS.length];
  document.body.style.backgroundImage=`url('${url}')`;
}
function startDefaultBackgroundRotation(){
  // Restore last index if present for continuity
  const savedIdx=parseInt(localStorage.getItem('bgDefaultIdx')||'0',10);
  if(!Number.isNaN(savedIdx)) bgRotationIndex=savedIdx % DEFAULT_BACKGROUNDS.length;
  setDefaultBackground(bgRotationIndex);
  clearInterval(bgRotationTimer);
  bgRotationTimer=setInterval(()=>{
    bgRotationIndex=(bgRotationIndex+1)%DEFAULT_BACKGROUNDS.length;
    localStorage.setItem('bgDefaultIdx',String(bgRotationIndex));
    setDefaultBackground(bgRotationIndex);
  }, DEFAULT_BG_ROTATE_SECS*1000);
}

// State v7 with scan phase and pause
const STATE_KEY='boabed_game_state_v7';
let words=[],defaultWords=['Ø³ÙŠØ§Ø±Ø©','Ø«Ù„Ø¬','Ù…Ø·Ø§Ø±','Ù…ÙØ§Ø¬Ø£Ø©','Ù‚Ù‡ÙˆØ©','Ù…ÙˆØ³ÙŠÙ‚Ù‰','Ø³ÙØ±Ø©','Ø±ÙˆØ³ÙŠØ§','Ù‚Ø·Ø§Ø±','Ø¯Ø¨ Ù‚Ø·Ø¨ÙŠ','ÙƒÙˆØ¨ Ø´Ø§ÙŠ','Ø­Ø¯ÙŠÙ‚Ø©','ÙÙ†Ø¯Ù‚','Ù…ØªØ­Ù','ÙƒØ±Ø© Ù‚Ø¯Ù…','Ø¬Ø³Ø±','Ù‚Ù…Ø±','Ø´Ù…Ø³','Ù…Ø·Ø±','Ù…Ø³Ø±Ø­'],
    scores=[],teamScores=[],playerCount=0,teamCount=0,currentPlayer=0,currentWordIndex=0,geminiKey='',
    usedWordsCount=0,timerInterval=null,mode='individual',streak=[],hintUsed=false,stage='playing',
    phase='scan',paused=false,remainingScanSecs=20,remainingPlaySecs=170,
    lastRevealGif='';
// Configurable scan duration (seconds)
let configuredScanSecs = 20;

const $=s=>document.querySelector(s);
// Random reveal GIFs
const REVEAL_GIFS=[
  'https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExdmVuM2x1N3dvYW1lZzRpOTNqN3N3YnM3OWVrNHZzdzJjYnR1cWhnOSZlcD12MV9naWZzX3RyZW5kaW5nJmN0PWc/fUQ4rhUZJYiQsas6WD/200.webp',
  'https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExamp0b3B3Y3VnNGo4ZnF0ZTZyOG0zZmlkNTdsZnAyYXN4Zm96em1pbCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/mFdnWF1RTI7fi/200w.webp',
  'https://media0.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3bzE3c3ZjeWxnaW9qZDZkNW1hYXdpZ2N3bXltaGIxYjhvZTZ6MWRsNSZlcD12MV9naWZzX3NlYXJjaCZjdD1n/88iYsvbegSUn9bSTF8/giphy.webp',
  'https://media2.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3bzE3c3ZjeWxnaW9qZDZkNW1hYXdpZ2N3bXltaGIxYjhvZTZ6MWRsNSZlcD12MV9naWZzX3NlYXJjaCZjdD1n/ylyUQnn01Vh23qfq3m/200.webp',
  'https://media2.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3cWQ1MDlmOWVtYm9vbzI2aW1uZmo1bWE5ZnRwZTQ2bXRwamFueXc4eSZlcD12MV9naWZzX3NlYXJjaCZjdD1n/Y9pvW54NNPRacOKg2D/200.webp',
  'https://media2.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3dG5ua2Z3ZTM1c2w2N2c4emduMHdsZTNraHgyMjdsZWtzenZ4eWR2aiZlcD12MV9naWZzX3NlYXJjaCZjdD1n/Lk023zZqHJ3Zz4rxtV/giphy.webp',
  'https://media4.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3eXQycXZsanc5MmlpZHh0OGRsc3Nub21xNzNuaWNsMzk3MHVqZWtuaiZlcD12MV9naWZzX3JlbGF0ZWQmY3Q9Zw/MCndepawQqgCs/giphy.webp',
  'https://media1.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3ZWxuaXkwdzRhOHFtbXVtYnQwdmpheTVlOWhnYTliZmp6cTV1dHljYSZlcD12MV9naWZzX3JlbGF0ZWQmY3Q9Zw/DA8op0omzFuwe14iyj/giphy.webp',
  'https://media4.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3djF3NjJtZjk0a3NsMmx2MHQwdW0wODFrYTFqcjJkMmJ3MXlvZTFpaSZlcD12MV9naWZzX3JlbGF0ZWQmY3Q9Zw/sC37EpvhNQ2GhXGwdc/giphy.webp',
  'https://media4.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3djF3NjJtZjk0a3NsMmx2MHQwdW0wODFrYTFqcjJkMmJ3MXlvZTFpaSZlcD12MV9naWZzX3JlbGF0ZWQmY3Q9Zw/Q5Ra0QQUpPYdlFmFrj/200w.webp',
  'https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExbGtoNjFwOGtvMXBmZno1OHozbWl4aXJuNGc1MmlvdHV0dmVwNHZkayZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/PIEHvHyvDGZiMsN2Cb/giphy.gif',
  'https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExdGV0dmZlaDkwamphcjR4d29lMDdhYTVwbDFjdnBpaG1wMmVjcmF1dyZlcD12MV9naWZzX3NlYXJjaCZjdD1n/10AmJ6TIlbYxAk/giphy.webp',
  'https://media2.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3YjBjMDNic2FhaTdoZnU4NHBkcnJreWI5eW91bWFxa2lyM28xcXpoeCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/mIZ9rPeMKefm0/giphy.webp',
  'https://media2.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3dHZ5Z3VqajBlbW1kOXRmcDR0aXAzcmJ0aGM5em9hbnRwejZsZW5sciZlcD12MV9naWZzX3NlYXJjaCZjdD1n/atQF1zaSGq8s8/giphy.webp'
];

const preloaded = REVEAL_GIFS.map(u=>{ const i=new Image(); i.src=u; return i; });
function pickRevealGifSafe(){
  const u = REVEAL_GIFS[Math.floor(Math.random()*REVEAL_GIFS.length)];
  return (preloaded.find(i=>i.src===u && i.complete) ? u : REVEAL_GIFS[0]);
}

function utf8Encode(str){return unescape(encodeURIComponent(str));}
function renderQR(text){const qrBox=$('#qr');qrBox.innerHTML='';const qr=qrcode(0,'L');qr.addData(utf8Encode(text),'Byte');qr.make();qrBox.innerHTML=qr.createImgTag(6,0);}
function cleanLines(text){
  const raw=text.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const out=[];const seen=new Set();
  for(let l of raw){
    l=l.replace(/^\s*\d+[)\-:\.]?\s*/,'');
    l=l.replace(/\[[^\]]*\]|\([^)]*\)|\{[^}]*\}/g,'');
    l=l.replace(/(?:19|20)\d{2}(?:\s*[â€“â€”-]\s*(?:19|20)\d{2})?/g,'');
    l=l.replace(/\b(?:TV|Mini|Series|Mini Series|TV Series|eps?|episodes?|season|seasons|IMDb|IMDB|rating|PG-?\d{0,2}|TV-?[A-Z-]+|Y7(?:-FV)?|G|PG|R|NR)\b/gi,'');
    l=l.replace(/[â€¢Â·|]/g,'');
    l=l.replace(/^[\-â€“â€”â€¢\s]+/,'');
    l=l.replace(/\s{2,}/g,' ').trim();
    if(!/[A-Za-z\u0621-\u064A]{2,}/.test(l))continue;
    if(l.length>60)continue;
    const k=l.toLowerCase();
    if(!seen.has(k)){seen.add(k);out.push(l)}
  }
  return out
}
function show(el){el.style.display='';}
function hide(el){el.style.display='none';}
function toast(msg,type='info'){const t=$('#toast');t.className='';t.classList.add('toast-'+(type==='success'?'success':type==='warn'?'warn':type==='error'?'error':'info'));t.textContent=msg;t.style.display='block';setTimeout(()=>t.style.display='none',3000);}

function saveState(){
  const state={
    words,mode,playerCount,teamCount,scores,teamScores,currentPlayer,currentWordIndex,
    usedWordsCount,hintUsed,stage,currentLang,
    phase,paused,remainingScanSecs,remainingPlaySecs,
    configuredScanSecs,
    lastRevealGif,
    homeHidden:$('#home').style.display==='none',
    gameVisible:$('#gameArea').style.display==='flex'
  };
  localStorage.setItem(STATE_KEY,JSON.stringify(state));
}

function loadState(){
  const s=localStorage.getItem(STATE_KEY);
  if(!s)return false;
  try{
    const st=JSON.parse(s);
    if(!st.words)return false;
    words=st.words;mode=st.mode||'individual';
    playerCount=st.playerCount||0;teamCount=st.teamCount||0;
    scores=st.scores||[];teamScores=st.teamScores||[];
    currentPlayer=st.currentPlayer||0;currentWordIndex=st.currentWordIndex||0;
    usedWordsCount=st.usedWordsCount||0;hintUsed=!!st.hintUsed;stage=st.stage||'playing';
    phase=st.phase||'scan';paused=!!st.paused;
    remainingScanSecs=st.remainingScanSecs ?? 20;
    remainingPlaySecs=st.remainingPlaySecs ?? 170;
    configuredScanSecs = st.configuredScanSecs ?? 20;
    lastRevealGif=st.lastRevealGif||'';

    if(st.currentLang) {
      currentLang = st.currentLang;
      updateLanguage();
    }

    if(st.homeHidden) { $('#home').style.display='none'; } else { $('#home').style.display='block'; }
    if(st.gameVisible){
      $('#gameArea').style.display='flex';
      buildScoreboard();restoreTurn();
    } else {
      $('#gameArea').style.display='none';
    }
    updateHomeStats();
    return true;
  }catch(e){
    return false;
  }
}

function updateGameUI() {
  $('#turn').textContent=`${translate('turn')} ${translate(mode==='individual'?'player':'team')} ${currentPlayer+1}`;
  $('#modeBadge').querySelector('span').textContent = translate(mode==='individual'?'mode_individual':'mode_team');
  updateProgress();
}

window.addEventListener('beforeunload',saveState);
if(localStorage.getItem('bgImageData')){
  document.body.style.backgroundImage=`url('${localStorage.getItem('bgImageData')}')`
}else{
  startDefaultBackgroundRotation();
}
$('#bgUpload').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{const data=ev.target.result;document.body.style.backgroundImage=`url('${data}')`;localStorage.setItem('bgImageData',data);if(bgRotationTimer){clearInterval(bgRotationTimer);bgRotationTimer=null;}};r.readAsDataURL(f)});

const previewModal=$('#previewModal');
function openPreview(list){$('#previewList').innerHTML='<ol>'+list.map(w=>`<li>${w}</li>`).join('')+'</ol>';previewModal.classList.add('active')}
$('#previewBtn').onclick=()=>{if(words.length===0){toast(translate('no_words'),'warn');return}openPreview(words)}
$('#closePreview').onclick=()=>previewModal.classList.remove('active')

const setupModal=$('#setupModal');
const closeSetup=document.getElementById('closeSetup');
if(closeSetup){closeSetup.onclick=()=>setupModal.classList.remove('active');}
$('#setupBtn').onclick=()=>{updateCurrentCount();setStep(1);const si=document.getElementById('scanSecsInput');if(si){si.value = configuredScanSecs;}setupModal.classList.add('active')}
function setStep(n){['s1','s2','s3'].forEach((id,i)=>{$('#'+id).classList.toggle('active',i===n-1)});['step1','step2','step3'].forEach((id,i)=>{$('#'+id).style.display=(i===n-1)?'block':'none'})}
Array.from(document.querySelectorAll('input[name="mode"]')).forEach(r=>r.onchange=()=>{mode=r.value;$('#modeBadge').querySelector('span').textContent=translate(mode==='individual'?'mode_individual':'mode_team');$('#individualInputs').style.display=(mode==='individual')?'block':'none';$('#teamInputs').style.display=(mode==='team')?'block':'none';});
$('#toStep2').onclick=()=>setStep(2);
$('#backTo1').onclick=()=>setStep(1);
$('#toStep3').onclick=()=>{if(words.length===0){toast('Ø§Ø®ØªØ±/Ø£Ø¯Ø®Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹','warn');return}buildSummary();setStep(3)};
$('#backTo2').onclick=()=>setStep(2);
function updateCurrentCount(){const el=document.getElementById('currentCount');if(el)el.textContent=words.length}

// Shuffle helpers
function shuffleInPlace(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr}
function shuffleForGameplay(){
  if($('#gameArea').style.display==='flex' && usedWordsCount>0){
    // Keep used, shuffle remaining
    const used=words.slice(0,usedWordsCount);
    const rem=words.slice(usedWordsCount);
    shuffleInPlace(rem);
    words=[...used,...rem];
  }else{
    shuffleInPlace(words);
  }
}

// Save list actions (now shuffle on save)
function saveDirect(){
  const cleaned=cleanLines($('#pasteArea').value);
  if(cleaned.length===0){toast(translate('empty_list'),'warn');return}
  words=cleaned;
  shuffleForGameplay();
  $('#pasteArea').value=words.join('\n');
  updateCurrentCount();
  toast(translate('saved_direct'),'success');
  saveState()
}
$('#saveDirect').onclick=saveDirect;

async function ensureGeminiKey(){if(geminiKey)return geminiKey;const v=$('#geminiKeyInput')?$('#geminiKeyInput').value.trim():'';if(v){geminiKey=v;return geminiKey}return await new Promise(res=>{const m=$('#apiKeyModal');if(!m){res(null);return}m.classList.add('active');const confirm=$('#confirmApi');const cancel=$('#cancelApi');if(confirm)confirm.onclick=()=>{const k=$('#apiKeyField').value.trim();if(!k){toast(translate('enter_key'),'error');return}geminiKey=k;m.classList.remove('active');res(k)};if(cancel)cancel.onclick=()=>{m.classList.remove('active');res(null)}})}
async function geminiExtractOrGenerate(key,promptText){const res=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key='+key,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify({contents:[{parts:[{text:promptText}]}]})});const data=await res.json();let text='';if(data.candidates&&data.candidates[0]&&data.candidates[0].content&&data.candidates[0].content.parts&&data.candidates[0].content.parts[0]){text=data.candidates[0].content.parts[0].text||''}else if(data.text){text=data.text}return text}
async function generateWithGemini(){
  const key=await ensureGeminiKey();if(!key){toast(translate('enter_key'),'error');return}
  const topic=$('#geminiTopic').value.trim()||'Ù…ÙˆØ§Ø¶ÙŠØ¹ Ù…ØªÙ†ÙˆØ¹Ø©';
  const num=parseInt($('#geminiCount').value)||20;
  try{
    const promptText=`Ø£Ù†Øª Ù…ÙÙ†Ù‚Ù‘ÙŠ/Ù…ÙˆÙ„Ù‘Ø¯ Ù„ÙƒÙ„Ù…Ø§Øª Ù„Ø¹Ø¨Ø© ØªÙ…Ø«ÙŠÙ„ ØµØ§Ù…Øª. Ø§Ù„Ù…Ø¯Ø®Ù„ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù…ÙˆØ¶ÙˆØ¹Ù‹Ø§ Ø¹Ø§Ù…Ù‹Ø§ Ø£Ùˆ Ù†ØµÙ‹Ø§ ÙÙˆØ¶ÙˆÙŠÙ‹Ø§ ÙŠØ­ØªÙˆÙŠ Ø£Ù…Ø«Ù„Ø©. Ø£Ø¹Ø¯ Ø¨Ø§Ù„Ø¶Ø¨Ø· ${num} Ø¹Ù†ØµØ±Ù‹Ø§ Ù…Ù†Ø§Ø³Ø¨Ù‹Ø§ Ù„Ù„Ø¹Ø¨Ø©. Ø¥Ø°Ø§ Ø¨Ø¯Ø§ Ø§Ù„Ù…Ø¯Ø®Ù„ Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ¶ÙˆÙŠØ© ÙØ§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆÙ†Ù‚ÙÙ‘Ù‡Ø§ØŒ ÙˆØ¥Ù„Ø§ Ø£Ù†Ø´Ø¦ Ø¹Ù†Ø§ØµØ± Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹. Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯: Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ ÙÙŠ ÙƒÙ„ Ø³Ø·Ø± ÙÙ‚Ø·ØŒ Ø¨Ø¯ÙˆÙ† ØªØ±Ù‚ÙŠÙ… Ø£Ùˆ Ø£Ù‚ÙˆØ§Ø³ Ø£Ùˆ Ø³Ù†ÙˆØ§Øª Ø£Ùˆ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø£Ùˆ ÙƒÙ„Ù…Ø§Øª Ù…Ø«Ù„ TV Series/eps/seasonØŒ Ø§Ø­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§ØªØŒ Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù„ØºØ© ÙƒÙ„ Ø¹Ù†ØµØ± ÙƒÙ…Ø§ ÙˆØ±Ø¯ØªØŒ ÙˆÙŠÙØ¶Ù„ 1â€“3 ÙƒÙ„Ù…Ø§Øª. Ø§Ù„Ù…Ø¯Ø®Ù„:\n\n${topic}`;
    const text=await geminiExtractOrGenerate(key,promptText);
    let preview=cleanLines(text||topic);
    if(preview.length>num)preview=preview.slice(0,num);
    if(preview.length===0){toast(translate('no_words_error'),'error');return}
    const box=$('#geminiPreview');
    box.style.display='block';
    box.innerHTML='<ol>'+preview.map(w=>`<li>${w}</li>`).join('')+'</ol>';
    document.getElementById('geminiAcceptRow').style.display='flex';
    box.dataset.tmp=JSON.stringify(preview)
  }catch(e){toast(translate('connection_error'),'error')}
}
$('#generateGemini').onclick=generateWithGemini;

$('#acceptGemini').onclick=()=>{
  const box=$('#geminiPreview');
  if(!box.dataset.tmp){toast(translate('no_preview'),'warn');return}
  words=JSON.parse(box.dataset.tmp);
  shuffleForGameplay();
  updateCurrentCount();
  toast(translate('accepted_gemini'),'success');
  saveState()
}

async function saveWithGemini(){
  const raw=$('#pasteArea').value.trim();if(!raw){toast(translate('empty_paste'),'warn');return}
  const key=await ensureGeminiKey();if(!key){toast(translate('enter_key'),'error');return}
  try{
    const promptText=`Ø£Ù†Øª Ø£Ø¯Ø§Ø© ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ù„Ù‚ÙˆØ§Ø¦Ù… Ù„Ø¹Ø¨Ø© ØªÙ…Ø«ÙŠÙ„ ØµØ§Ù…Øª. ÙŠÙØ¯Ø®Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ØµÙ‹Ø§ ÙÙˆØ¶ÙˆÙŠÙ‹Ø§ Ù‚Ø¯ ÙŠØ­ÙˆÙŠ ØªØ±Ù‚ÙŠÙ…Ù‹Ø§ ÙˆØ³Ù†ÙˆØ§Øª ÙˆØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙˆØ£Ø³Ù…Ø§Ø¡ Ù…Ù…Ø«Ù„ÙŠÙ† ÙˆØ£ÙˆØµØ§ÙÙ‹Ø§. Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø§Ø³ØªØ®Ø±Ø¬ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø· (Ù…Ø«Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª/Ø§Ù„Ø£ÙÙ„Ø§Ù…/Ø§Ù„Ø£Ø´ÙŠØ§Ø¡) Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ ÙÙŠ ÙƒÙ„ Ø³Ø·Ø±ØŒ Ø¨Ø¯ÙˆÙ† ØªØ±Ù‚ÙŠÙ… Ø£Ùˆ Ø£Ù‚ÙˆØ§Ø³ Ø£Ùˆ Ø³Ù†ÙˆØ§Øª Ø£Ùˆ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø£Ùˆ ÙƒÙ„Ù…Ø§Øª Ù…Ø«Ù„ TV Series/Mini Series/eps/seasonØŒ ÙˆØ§Ø­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§ØªØŒ ÙˆÙ„Ø§ ØªÙØ¶Ù Ø£ÙŠ Ù†Øµ Ø¢Ø®Ø± ÙˆÙ„Ø§ ØªØªØ±Ø¬Ù…. Ø§Ù„Ù†Øµ:\n\n${raw}`;
    const text=await geminiExtractOrGenerate(key,promptText);
    let cleaned=cleanLines(text);
    if(cleaned.length===0)cleaned=cleanLines(raw);
    if(cleaned.length===0){toast(translate('no_valid_words'),'error');return}
    words=cleaned; shuffleForGameplay();
    $('#pasteArea').value=words.join('\n');
    updateCurrentCount();
    toast(translate('cleaned_saved'),'success');
    saveState()
  }catch(e){toast(translate('connection_error'),'error')}
}
$('#saveWithGemini').onclick=saveWithGemini;

function buildSummary(){
  $('#summary').innerHTML=`<b>${translate(mode==='individual'?'mode_individual':'mode_team')}:</b> Â· <b>${translate('words')}:</b> ${words.length}`;
  $('#finalPreview').innerHTML='<ol>'+words.map(w=>`<li>${w}</li>`).join('')+'</ol>'
}

$('#confirmSetup').onclick=()=>{
  if(mode==='individual'){
    playerCount=parseInt($('#playersCount').value)||1;
    scores=new Array(playerCount).fill(0);
    streak=new Array(playerCount).fill(0)
  }else{
    teamCount=parseInt($('#teamsCount').value)||2;
    playerCount=teamCount;
    teamScores=new Array(playerCount).fill(0);
    streak=new Array(playerCount).fill(0)
  }
  // Save configured scan seconds
  const scanInput=document.getElementById('scanSecsInput');
  if(scanInput){ configuredScanSecs = Math.max(5, Math.min(60, parseInt(scanInput.value)||20)); }
  setupModal.classList.remove('active');
  toast(translate('setup_ready'),'success');
  if($('#muteOnStart').checked){bgm.pause()}else{bgm.play()}
  saveState()
}

function updateHomeStats(){
  $('#homeStats').innerHTML=words.length?`<span class="badge">${translate('current_list')}${words.length} ${translate('words')}</span>`:''
}
function buildScoreboard(){
  const sb=$('#scoreboard');sb.innerHTML='';
  const arr=(mode==='individual')?scores:teamScores;
  arr.forEach((s,i)=>{
    const div=document.createElement('div');
    div.className='player';div.dataset.idx=i;
    div.innerHTML=`${translate(mode==='individual'?'player':'team')} ${i+1}: <span>${(+s).toFixed(1)}</span>`;
    sb.appendChild(div)
  });
  highlightActive()
}
function updateScore(idx){const span=document.querySelector(`.player[data-idx="${idx}"] span`);if(span){const arr=(mode==='individual')?scores:teamScores;span.textContent=(+arr[idx]).toFixed(1)}}
function highlightActive(){document.querySelectorAll('.player').forEach(p=>p.classList.remove('active'));const el=document.querySelector(`.player[data-idx="${currentPlayer}"]`);if(el)el.classList.add('active')}

function goHome(){
  $('#gameArea').style.display='none';
  $('#home').style.display='block';
  bgm.pause();
  stage='ended';
  clearInterval(timerInterval);
  saveState();
  updateHomeStats();
  $('#gameEndModal').classList.remove('active');
}

// Timer + Phases
function updateProgress(){$('#progress').textContent=`${translate('word')} ${usedWordsCount+1} ${translate('of')} ${words.length}`}

function formatMMSS(x){const m=Math.floor(x/60).toString().padStart(2,'0');const s=(x%60).toString().padStart(2,'0');return `${m}:${s}`}

function tickTimer(){
  const tEl=$('#timer');
  if(phase==='scan'){
    tEl.classList.add('scan'); tEl.classList.remove('low');
    tEl.textContent = `${formatMMSS(remainingScanSecs)}`
  }else{
    tEl.classList.remove('scan');
    if(remainingPlaySecs<=15)tEl.classList.add('low'); else tEl.classList.remove('low');
    tEl.textContent = `${formatMMSS(remainingPlaySecs)}`
  }
  tEl.classList.toggle('paused', paused);
}

function startScanPhase(){
  phase='scan'; paused=false;
  remainingScanSecs = Math.max(5, Math.min(60, Number(configuredScanSecs) || 20));
  $('#qr').classList.add('scan-phase');
  $('#qr').setAttribute('data-scan-label', translate('scan_qr'));
  $('#revealBtn').disabled = true;
  $('#hintBtn').disabled = true;
  toast(translate('scan_free'),'info');
  clearInterval(timerInterval);
  tickTimer();
  timerInterval=setInterval(()=>{
    if(paused) return;
    remainingScanSecs--; tickTimer();
    if(remainingScanSecs<=0){
      clearInterval(timerInterval);
      endScanStartPlay();
    }
    saveState();
  },1000)
}

function endScanStartPlay(){
  $('#qr').classList.remove('scan-phase');
  $('#revealBtn').disabled = false;
  $('#hintBtn').disabled = false;
  startPlayTimer();
}

function startPlayTimer(initial=null){
  phase='play';
  if(initial!==null){remainingPlaySecs=initial}else{remainingPlaySecs=170}
  clearInterval(timerInterval);
  tickTimer();
  timerInterval=setInterval(()=>{
    if(paused) return;
    remainingPlaySecs--;
    tickTimer();
    if(remainingPlaySecs<=0){
      clearInterval(timerInterval);
      reveal();
    }
    saveState();
  },1000)
}

function togglePause(){
  paused = !paused;
  const btn=$('#pauseBtn');
  if(btn) btn.textContent = translate(paused ? 'resume' : 'pause');
  tickTimer();
  saveState();
}

// Turn flow
function showTurn(){
  $('#answer').style.display='none';
  $('#hint').textContent='';
  hintUsed=false;
  $('#playRow').style.display='flex';
  $('#actionRow').style.display='none';
  updateGameUI(); updateProgress();
  const special=((usedWordsCount+1)%5===0);
  $('#qr').classList.toggle('special',special);
  renderQR(words[currentWordIndex]);
  startScanPhase();
  highlightActive();
  stage='playing';
  saveState()
}

function reveal(){
  $('#answer').textContent=words[currentWordIndex];
  $('#answer').style.display='block';
  $('#playRow').style.display='none';
  $('#actionRow').style.display='flex';
  lastRevealGif = pickRevealGifSafe();
  $('#qr').innerHTML=`<img src="${lastRevealGif}" style="width:256px;height:256px;border-radius:12px;object-fit:cover">`;
  clearInterval(timerInterval);
  stage='revealed';
  saveState()
}

function calcPoints(){
  // Use only gameplay remaining time (scan time excluded)
  if(hintUsed)return 0.5;
  let pts=1.0;
  if(remainingPlaySecs>120)pts+=0.5;
  else if(remainingPlaySecs>60)pts+=0.25;
  if(remainingPlaySecs>150)pts+=0.5;
  return Math.max(0.1,Math.round(pts*10)/10)
}

function checkAchievements(points){
  const arr=(mode==='individual')?scores:teamScores;
  const s=arr[currentPlayer];
  if(points>=1.5)pushBadge(translate('speed_bonus'));
  if(s>=10)pushBadge(translate('reached_10'))
}
function pushBadge(html){const box=$('#achievements');const el=document.createElement('div');el.className='badge badge-pop';el.innerHTML=html;box.appendChild(el);setTimeout(()=>el.remove(),4000)}

function judge(correct){
  if(correct){
    const earned=calcPoints();
    if(mode==='individual'){scores[currentPlayer]+=earned}else{teamScores[currentPlayer]+=earned}
    updateScore(currentPlayer);
    toast(`${translate(mode==='individual'?'player':'team')} ${currentPlayer+1} ${translate('scored')} ${earned.toFixed(1)} ${translate('points')}!`,'success');
    checkAchievements(earned)
  }else{
    toast(translate('wrong_answer'),'warn')
  }
  next(true)
}

function next(advanceTurn){
  usedWordsCount++;
  if(usedWordsCount>=words.length){return endGame()}
  currentWordIndex=(currentWordIndex+1)%words.length;
  if(advanceTurn){currentPlayer=(currentPlayer+1)%playerCount}
  showTurn(); saveState()
}
function skipWord(){
  usedWordsCount++;
  if(usedWordsCount>=words.length){return endGame()}
  currentWordIndex=(currentWordIndex+1)%words.length;
  showTurn(); saveState()
}

function endGame(){
  $('#gameArea').style.display='none';
  const arr=(mode==='individual')?scores:teamScores;
  const max=Math.max(...arr);
  const winners=[];
  const finalScoresHtml=arr.map((s,i)=>{
    const isWinner = s === max;
    if(isWinner) winners.push(`${translate(mode==='individual'?'player':'team')} ${i+1}`);
    return `<div class="score-item ${isWinner?'winner':''}">
      <span>${translate(mode==='individual'?'player':'team')} ${i+1}</span>
      <span>${s.toFixed(1)} ${translate('points')}</span>
    </div>`;
  }).join('');

  $('#winnerName').textContent = `ğŸ† ${winners.join(' Ùˆ ')}`;
  $('#finalScores').innerHTML = finalScoresHtml;
  $('#gameEndModal').classList.add('active');

  if(!window._muted) {
    bgm.currentTime = 0;
    bgm.play();
  }
}

$('#playAgainBtn').onclick = () => {
  $('#gameEndModal').classList.remove('active');
  if(mode==='individual') { scores = new Array(playerCount).fill(0); }
  else { teamScores = new Array(playerCount).fill(0); }
  currentPlayer = 0;
  currentWordIndex = 0;
  usedWordsCount = 0;
  stage = 'playing';
  // Shuffle full list for new round
  words = [...words].sort(() => Math.random() - 0.5);
  startGame();
  toast(translate('new_game_start'), 'success');
};

$('#backToHomeBtn').onclick = () => {
  $('#gameEndModal').classList.remove('active');
  goHome();
};

function restoreTurn(){
  $('#home').style.display='none';
  $('#gameArea').style.display='flex';
  buildScoreboard();
  updateGameUI(); updateProgress(); highlightActive();
  if(stage==='revealed'){
    $('#answer').textContent=words[currentWordIndex];
    $('#answer').style.display='block';
    $('#playRow').style.display='none';
    $('#actionRow').style.display='flex';
    if(!lastRevealGif) lastRevealGif = pickRevealGifSafe();
    $('#qr').innerHTML=`<img src="${lastRevealGif}" style="width:256px;height:256px;border-radius:12px;object-fit:cover">`;
  }else if(stage==='playing'){
    $('#answer').style.display='none';
    $('#playRow').style.display='flex';
    $('#actionRow').style.display='none';
    renderQR(words[currentWordIndex]);
    if(phase==='scan'){
      $('#qr').classList.add('scan-phase');
      $('#qr').setAttribute('data-scan-label', translate('scan_qr'));
      $('#revealBtn').disabled=true; $('#hintBtn').disabled=true;
      clearInterval(timerInterval); tickTimer();
      timerInterval=setInterval(()=>{
        if(paused)return;
        remainingScanSecs--; tickTimer();
        if(remainingScanSecs<=0){clearInterval(timerInterval); endScanStartPlay();}
        saveState();
      },1000);
    }else{
      $('#qr').classList.remove('scan-phase');
      $('#revealBtn').disabled=false; $('#hintBtn').disabled=false;
      clearInterval(timerInterval); tickTimer();
      timerInterval=setInterval(()=>{
        if(paused)return;
        remainingPlaySecs--; tickTimer();
        if(remainingPlaySecs<=0){clearInterval(timerInterval); reveal();}
        saveState();
      },1000);
    }
  }
}

// Hint menu with adaptive options
function makePartialHint(word, part){
  const clean=word.replace(/[^\u0621-\u064A\sA-Za-z]/g,'');
  const L=clean.length||word.length;
  const k=Math.max(1,Math.ceil(L*0.3));
  if(part==='begin'){return clean.slice(0,k)+'â€¦'}
  if(part==='end'){return 'â€¦'+clean.slice(Math.max(0,L-k))}
  if(part==='middle'){
    const start=Math.max(1,Math.floor((L-k)/2));
    return 'â€¦'+clean.slice(start,start+k)+'â€¦'
  }
  return clean.slice(0,Math.max(1,Math.ceil(L*0.3)))+'â€¦'
}

const hintMenu = document.createElement('div');
hintMenu.className='hint-menu';
hintMenu.id='hintMenu';
hintMenu.innerHTML = `
  <div class="hint-title"></div>
  <button data-part="begin"></button>
  <button data-part="middle"></button>
  <button data-part="end"></button>
`;
document.body.appendChild(hintMenu);

function positionHintMenu(){
  const btn=$('#hintBtn');
  const r=btn.getBoundingClientRect();
  hintMenu.style.left = (r.left + window.scrollX) + 'px';
  hintMenu.style.top = (r.bottom + window.scrollY + 8) + 'px';
}
function openHintMenu(){
  if(hintUsed) return;
  positionHintMenu();
  hintMenu.querySelector('.hint-title').textContent = translate('choose_hint_part');
  hintMenu.querySelector('button[data-part="begin"]').textContent = translate('reveal_begin');
  hintMenu.querySelector('button[data-part="middle"]').textContent = translate('reveal_middle');
  hintMenu.querySelector('button[data-part="end"]').textContent = translate('reveal_end');
  hintMenu.classList.add('active');
}
function closeHintMenu(){hintMenu.classList.remove('active')}

hintMenu.addEventListener('click', (e)=>{
  const btn=e.target.closest('button[data-part]');
  if(!btn) return;
  const part=btn.getAttribute('data-part');
  const word=words[currentWordIndex];
  const hintStr = makePartialHint(word, part);
  $('#hint').textContent = translate('hint') + hintStr;
  hintUsed=true;
  closeHintMenu();
  toast(translate('hint_used'),'warn');
  saveState();
});
document.addEventListener('click', (e)=>{
  const within = e.target.closest('#hintMenu') || e.target.closest('#hintBtn');
  if(!within) closeHintMenu();
});
window.addEventListener('resize', ()=>{ if(hintMenu.classList.contains('active')) positionHintMenu(); });

// Controls
function startGame(){
  if(words.length===0){
    if(confirm(translate('no_word_list'))){words=[...defaultWords];updateHomeStats()}
    else{toast(translate('setup_first'),'warn');return}
  }
  // Initialize/Reset player/team arrays (keep words unchanged)
  if(mode==='individual'){
    if(playerCount<=0){playerCount=3;}
    scores = new Array(playerCount).fill(0);
    teamScores = [];
  }else{
    if(playerCount<=0){playerCount=2;}
    teamScores = new Array(playerCount).fill(0);
    scores = [];
  }
  streak = new Array(playerCount).fill(0);
  // Shuffle list at game start
  shuffleInPlace(words);
  $('#home').style.display='none';
  $('#gameArea').style.display='flex';
  currentPlayer=0;currentWordIndex=0;usedWordsCount=0;
  phase='scan';paused=false;remainingScanSecs=Math.max(5, Math.min(60, Number(configuredScanSecs) || 20));remainingPlaySecs=170;
  stage='playing';
  // Clear any previous achievement toasts/badges
  const achBox = document.getElementById('achievements'); if(achBox) achBox.innerHTML='';
  buildScoreboard();showTurn();saveState()
}

$('#startBtn').onclick=startGame;
$('#revealBtn').onclick=()=>reveal();
$('#correctBtn').onclick=()=>judge(true);
$('#wrongBtn').onclick=()=>judge(false);
$('#skipBtn').onclick=skipWord;
$('#endGameInPlay').onclick=()=>{if(confirm(translate('confirm_end')))goHome()};
$('#hintBtn').onclick=()=>{ if(!hintUsed && !$('#hintBtn').disabled) openHintMenu(); };
$('#hintBtn').addEventListener('mouseenter', ()=>{ if(!hintUsed && !$('#hintBtn').disabled) openHintMenu(); });
$('#pauseBtn').onclick=togglePause;

// Optional mute button guard (in case it exists elsewhere)
window._muted=false;
const muteEl = document.getElementById('muteBtn');
if(muteEl){
  muteEl.onclick=()=>{
    window._muted=!window._muted;
    if(window._muted){bgm.pause();toast(translate('sounds_muted'),'info')}
    else{bgm.play();toast(translate('sounds_on'),'info')}
  };
}

window.addEventListener('DOMContentLoaded',()=>{loadState();updateHomeStats();});
</script>
</body>
</html>
